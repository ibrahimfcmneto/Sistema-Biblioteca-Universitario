<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consultas - Biblioteca</title>
  
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="logo">
    <img src="logo-puc.png" alt="Logo da Faculdade">
  </div>

  <div class="linha-colorida"></div>

  <div class="cadastro-container" style="max-width: 1000px;">

    <h1 class="titulo-form">Painel de Consultas</h1>
    <p class="subtitulo">Selecione abaixo o tipo de relat√≥rio que deseja visualizar.</p>

    <div class="tabs">
        <button class="tab-btn active-btn" onclick="abrirAba('pendentes')">Pendentes ‚ö†Ô∏è</button>
        <button class="tab-btn" onclick="abrirAba('acervo')">Todos os Livros üìö</button>
        <button class="tab-btn" onclick="abrirAba('historico')">Hist√≥rico de Empr√©stimos üìã</button>
    </div>

    <div id="pendentes" class="tabela-container ativo">
        <h3>Livros N√£o Devolvidos</h3>
        <table>
            <thead>
                <tr>
                    <th>Aluno</th>
                    <th>RA</th>
                    <th>Livro</th>
                    <th>Data Retirada</th>
                </tr>
            </thead>
            <tbody id="lista-pendentes"></tbody>
        </table>
        <p id="msg-pendentes" class="aviso-vazio">Carregando...</p>
    </div>

    <div id="acervo" class="tabela-container">
        <h3>Acervo Completo da Biblioteca</h3>
        <table>
            <thead>
                <tr>
                    <th>C√≥d.</th>
                    <th>T√≠tulo</th>
                    <th>Autor</th>
                    <th>Estoque (Disp./Total)</th>
                </tr>
            </thead>
            <tbody id="lista-acervo"></tbody>
        </table>
        <p id="msg-acervo" class="aviso-vazio">Carregando...</p>
    </div>

    <div id="historico" class="tabela-container">
        <h3>Hist√≥rico Geral de Movimenta√ß√µes</h3>
        <table>
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Aluno</th>
                    <th>Livro</th>
                    <th>Retirada</th>
                    <th>Devolu√ß√£o</th>
                </tr>
            </thead>
            <tbody id="lista-historico"></tbody>
        </table>
        <p id="msg-historico" class="aviso-vazio">Carregando...</p>
    </div>

    <br><br>
    <div style="text-align: center;">
        <a href="index.html" style="color: #333; text-decoration: none; font-weight: bold;">‚Üê Voltar ao Menu</a>
    </div>

  </div>

  <script>
    // --- FUN√á√ÉO PARA TROCAR DE ABA ---
    function abrirAba(idAba) {
        document.querySelectorAll('.tabela-container').forEach(div => div.classList.remove('ativo'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active-btn'));

        document.getElementById(idAba).classList.add('ativo');
        event.target.classList.add('active-btn');

        if(idAba === 'pendentes') carregarPendentes();
        if(idAba === 'acervo') carregarAcervo();
        if(idAba === 'historico') carregarHistorico();
    }

    // 1. CARREGAR PEND√äNCIAS
    function carregarPendentes() {
        fetch('/biblio-listar-pendencias')
            .then(res => res.json())
            .then(dados => {
                const tbody = document.getElementById('lista-pendentes');
                const msg = document.getElementById('msg-pendentes');
                tbody.innerHTML = '';
                msg.innerText = dados.length === 0 ? "Tudo certo! Nenhuma pend√™ncia." : "";

                dados.forEach(item => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${item.nome_aluno}</td>
                            <td>${item.ra_aluno}</td>
                            <td>${item.nome_livro}</td>
                            <td style="color:#e74c3c; font-weight:bold;">${item.data_saida}</td>
                        </tr>`;
                });
            });
    }

    // 2. CARREGAR ACERVO
    function carregarAcervo() {
        fetch('/listar-todos-livros')
            .then(res => res.json())
            .then(dados => {
                const tbody = document.getElementById('lista-acervo');
                const msg = document.getElementById('msg-acervo');
                tbody.innerHTML = '';
                msg.innerText = dados.length === 0 ? "Nenhum livro cadastrado." : "";

                dados.forEach(livro => {
                    const corEstoque = livro.quantidade_disponivel > 0 ? '#27ae60' : '#c0392b';
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${livro.codigo_livro}</td>
                            <td><strong>${livro.titulo}</strong></td>
                            <td>${livro.autor || '-'}</td>
                            <td style="color:${corEstoque}; font-weight:bold;">
                                ${livro.quantidade_disponivel} / ${livro.quantidade_total}
                            </td>
                        </tr>`;
                });
            });
    }

    // 3. CARREGAR HIST√ìRICO
    function carregarHistorico() {
        fetch('/biblio-todos-emprestimos')
            .then(res => res.json())
            .then(dados => {
                const tbody = document.getElementById('lista-historico');
                const msg = document.getElementById('msg-historico');
                tbody.innerHTML = '';
                msg.innerText = dados.length === 0 ? "Nenhum hist√≥rico encontrado." : "";

                dados.forEach(item => {
                    const classeStatus = item.status === 'Devolvido' ? 'status-devolvido' : 'status-emprestado';
                    const dataDev = item.data_devolucao || '---';
                    
                    tbody.innerHTML += `
                        <tr>
                            <td><span class="${classeStatus}">${item.status}</span></td>
                            <td>${item.nome_aluno}</td>
                            <td>${item.nome_livro}</td>
                            <td>${item.data_saida}</td>
                            <td>${dataDev}</td>
                        </tr>`;
                });
            });
    }

    window.onload = carregarPendentes;
  </script>

</body>
</html>